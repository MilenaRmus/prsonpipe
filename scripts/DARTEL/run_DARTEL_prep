#!/usr/bin/env bash
# type: sbatch -J name script.sh pfile "subs"
# subs should either be a matlab vector "[1:4 5:6]""
# Keep lines starting with #SBATCH together and at top of script! Modify settings as appropriate.

#SBATCH -J dartel				# Job name
#SBATCH --workdir=./			# Set working directory
#SBATCH -o ../../output/dartel-%j
#SBATCH -t 48:00:00				# Set runtime in hh:mm:ss, d-hh, d-hh:mm, mm:ss, or m
#SBATCH --mem 5120				# Set amount of memory in MB (1GB = 1024 MB)

pushd ../ > /dev/null
source globals.par
source funcs
popd > /dev/null 

label='[DARTEL]'
logfile=LOG.txt

# first arg is pfile
pfile=$1
# rest of args are subs (each arg separated by a space)
shift 
SUBS=( "$@" )

make_matlab_array SUBS[@]

echo "${label} $(date) Beginning DARTEL analysis of subject(s) ${matlab_array} with pfile ${pfile}" >> "${logfile}"

#echo "unziping nii files"
#for s in "${SUBS[@]}"; do
#	pushd ${PREP_DIR} > /dev/null 

# run matlab from the command line as part of a submit job
module load matlab/R2015b
# run script
matlab -nosplash -nodisplay -nodesktop -r "try; DARTEL_spm8_vars(${matlab_array},'$pfile'); catch me; fprintf('%s / %s\n',me.identifier,me.message); end; exit"

echo "${label} Done. $(date)" >> "${logfile}"
